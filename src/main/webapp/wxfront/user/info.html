<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <title>客户数据中心-用户信息</title>
  <link rel="stylesheet" href="../css/main.css">
  <script src="../../static/js/jquery.min.js" type="text/javascript"></script>
  <script src="../js/CONSTANT.js" type="text/javascript"></script>
  <script src="../js/common.utils.js" type="text/javascript"></script>
</head>

<body>
<div class="main" style="display:none">
<div class="item-yhm">
  <div class="item-my row">
    <div class="col-item-pic"><img id="portraitImg"></div>
    <div class="col-item-pic-2" id="userName"></div>
  </div>
</div>
<div class="line"></div>
<div class="item-yhm ">
  <div class="item-my row">
    <div class="col-pic"><img src="../images/pic_03.png"></div>
    <div class="col-xm">所在项目</div>
    <div class="col-xm-2" id="projs"></div>
  </div>
</div>
<div class="line"></div>
<div class="item-yhm ">
  <div class="item-my row">
    <div class="col-pic"><img src="../images/pic_09.png"></div>
    <div class="col-xm">用户类型</div>
    <div class="col-xm-2" id="roles"></div>
  </div>
</div>
<div class="line"></div>
<div class="item-yhm ">
  <div class="item-my row">
    <div class="col-pic"><img src="../images/pic_04.png"></div>
    <div class="col-xm">修改密码</div>
  </div>
</div>
<div class="line"></div>
<div class="item-yhm ">
  <div class="item-my row">
    <div class="col-pic"><img src="../images/pic_10.png"></div>
    <div class="col-xm"><a href="data.html">日数据统计</a></div>
  </div>
</div>
<div class="item-yhm ">
  <div class="item-my row">
    <div class="col-pic"><img src="../images/pic_11.png"></div>
    <div class="col-xm">周数据统计</div>
  </div>
</div>
<div class="item-yhm ">
  <div class="item-my row">
    <div class="col-pic"><img src="../images/pic_12.png"></div>
    <div class="col-xm">月数据统计</div>
  </div>
</div>
<div class="line"></div>
<div class="xxts" id="comment"></div>
</div>

<div class="hidding" id="changePwdArea" style="display:none">
<!-- 
  <div class="item_inner-2">
    <input type="password" placeholder="请输入原密码" name="oldPwd"/>
  </div>
 -->
  <div class="item_inner-2">
    <input type="password" placeholder="请输入新密码" class="" name="newPwd"/>
  </div>
  <div class="item_inner-2">
    <input type="password" placeholder="再次输入新密码" class="" name="newPwdConfirm">
  </div>
  <div class="row row-link">
    <div class="col-50" style="margin-top:1.5rem;"><a href="#" id="savePwd">保存</a></div>
    <div class="col-50" style="margin-top:1.5rem;"><a href="#" id="cancelPwd">取消</a></div>
  </div>
  
</div>
</body>
<script>
$(function() {
  //获取用户数据
  var url=_URL_BASE+"/wx/api/personalCenter";
  //  var url="/wxmp.ql/wx/api/personalCenter";
  $.ajax({type:"post", async:true, url:url, data:null, dataType:"json",
    success: function(json) {
      if (json.msg=='100') {
        fillPage(json.userInfo);
        $("div[class='main']").show();
      } else {
        window.location.href=_URL_BASE+"/wxfront/err.html?1000=抱歉<br/>无法获得您的个人信息";
      }
    },
    error: function(XMLHttpRequest, textStatus, errorThrown) {
      window.location.href=_URL_BASE+"/wxfront/err.html?2000=系统错误<br/>status="
        +XMLHttpRequest.status+"<br/>readyState="+XMLHttpRequest.readyState+"<br/>text="+textStatus;
    }
  });
  //绑定修改密码方法
  $("div[class='col-xm']").click(function() {
    $("div[class='main']").hide();
    $("#changePwdArea").show();
  });
  //绑定修改密码中的取消按钮
  $("#cancelPwd").click(function(){
    $("div[class='main']").show();
    $("#changePwdArea").hide();
  });
  //绑定修改密码中的修改密码
  $("#savePwd").click(function(){
    savePwd();
  });
});

/**
 * 填充页面信息
 */
function fillPage(data) {
  $("#userName").html("<span>"+data.realname+"</span><span style='color:#999;font-size:.8rem;'>("+data.loginname+")</span><br/>"+data.mainphonenum);
  $("#portraitImg").attr("src",data.headimgurl);

  var userRoles=data.roleName+"";
  var lRole=userRoles.split(',');
  userRoles="";
  for (var i=0;i<lRole.length; i++) if ($.trim(lRole[i])!='') userRoles+=","+$.trim(lRole[i]);
  userRoles=userRoles.substr(1);
  $("#roles").html(""+userRoles);

  var prjNames=data.selfprojauth+"";
  if (data.checkProj) prjNames=""+data.checkProj;
  var userType=data.isvalidate;
  var pageComment="";
  if (userType=='0') pageComment="您的账号正在审核中，请耐心等待";
  else //审核通过
  if (userType=='1') pageComment="";
  else//审核未通过
  if (userType=='2') pageComment="您的账号未通过审核";
  else //作废
  pageComment="您的账号已作废";
  $("#comment").html(pageComment);

  var lPrj=prjNames.split(',');
  prjNames="";
  for (var i=0;i<lPrj.length; i++) if ($.trim(lPrj[i])!='') prjNames+="<br\/>"+$.trim(lPrj[i].substr(lPrj[i].indexOf('-')+1));
  prjNames=prjNames.substr(5);
  $("#projs").html(prjNames);
}

/*
 * 修改密码
 */
function savePwd() {
  var inputData={};
  inputData.newPwd=$("input[name='newPwd']").val();
  inputData.newPwdConfirm=$("input[name='newPwdConfirm']").val();

  var errMsg="";
  if (!inputData.newPwd) errMsg="密码为空";
  if (inputData.newPwd.length<6) errMsg="密码至少六位"; 
  if (inputData.newPwd!=inputData.newPwdConfirm) errMsg="密码与密码确认不匹配";
  if (errMsg!="")  alert(errMsg);
  else {
    delete inputData.newPwdConfirm;
    var url=_URL_BASE+"/wx/api/updateUserPwd";
    $.ajax({type:"post", async:true, url:url, data:inputData, dataType:"json",
      success: function(json) {
        msg="密码修改成功";
        if (json.msg!='100') msg="密码修改失败";
        alert(msg);
        $("div[class='main']").show();
        $("#changePwdArea").hide();
      },
      error: function(XMLHttpRequest, textStatus, errorThrown) {
        msg="[XMLHttpRequest]==\n"+allFields(XMLHttpRequest)+"\n[textStatus]==\n"+textStatus+"\n[errorThrown]==\n"+allFields(errorThrown);
        alert(msg);
        $("div[class='main']").show();
        $("#changePwdArea").hide();
      }
    });
  }
}
</script>
</html>