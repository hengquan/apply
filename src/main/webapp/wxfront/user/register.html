<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <title>客户数据中心-用户注册</title>
  <link href="http://netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../css/bootstrap.min.css"/>
  <link rel="stylesheet" href="../css/index.css"/>
  <link rel="stylesheet" href="../css/main.css">
  <link rel="stylesheet" href="../css/zepto.mdater.css">
  <script src="../../static/js/jquery.min.js" type="text/javascript"></script>
  <script src="../js/CONSTANT.js" type="text/javascript"></script>
  <script src="../js/common.utils.js" type="text/javascript"></script>
  <script src="../js/bootstrap.min.js"></script>
  <script src="../js/vue.js"></script>
</head>
<body>
  <header class="head-crm">
    <h1>客户数据中心用户注册</h1>
  </header>
  <!-- 表单区域 -->
  <div class="content" id="content">
    <div class="item_inner">
      <input type="text" name="loginName" placeholder="登录名">
    </div>
    <div class="item_inner">
      <input type="password" name="pwd" placeholder="密码">
    </div>
    <div class="item_inner">
      <input type="password"  name="pwdConfirm" placeholder="确认密码" class="">
    </div>
    <div class="item_inner">
      <input type="phone"  name="phoneNum" placeholder="手机号">
    </div>
    <div class="item_inner">
      <input type="text"  name="realName" placeholder="姓名">
    </div>
    <div class="item_inner">
      <input class="input_style" readonly="true" id="role" name="userRole" placeholder="用户类型" v-model="u_role" readonly class="form-group" data-toggle="modal" data-target="#userRoleModal"/>
    </div>
    <div class="modal fade" id="userRoleModal" role="dialog">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><span>&times</span></button>
            <h4 class="modal-title">&nbsp;</h4>
          </div>
          <div class="modal-body" id="userRoleData"></div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
            <button type="button" class="btn btn-default" data-dismiss="modal" @click="cleanRole()" id="cleanRoleBtn" style="display:none;">清除并关闭</button>
<!--             <button type="button" class="btn btn-primary" @click="selRole()">确定</button>  -->
          </div>
        </div>
      </div>
    </div>
    <div class="item_inner">
      <input type="text" name="prjs" placeholder="所属项目，可填入多个，逗号隔开">
    </div>
    <div class="item-zhc" name="commitBtn">立即注册</div>
  </div>
  <!-- 表单区域结束 -->
</body>
<script>
var _uRole="";
$(function() {
  //获取用户类型
  var url=_URL_BASE+"/wx/api/getRoleList";
  $.ajax({type:"post", async:true, url:url, data:null, dataType:"json",
    success: function(json) {
      if (json.msg=='100') initRols(json.roles);
    }
  });
  //绑定提交方法
  $("div[name='commitBtn']").click(function() {
    registerUser();
  });
});

//复选单选处理
new Vue({
  el: "#content",
  data:{
    u_role: ""
  },
  methods: {
    selRole: function() {
      var choose=document.getElementsByName('userRole');
      for (var i=0; i<choose.length; i++) {
        if (choose[i].checked==true) {
          this.u_role=choose[i].getAttribute("_text");
          _uRole=choose[i].value;
        }
      }
      $("#userRoleModal").modal('hide');
      if (_uRole!="") $("#cleanRoleBtn").show();
    },
    cleanRole: function() {
      this.u_role="";
   	  _uRole="";
      $("#cleanRoleBtn").hide();
      var choose=document.getElementsByName('userRole');
      for (var i=0; i<choose.length; i++) if (choose[i].checked==true) choose[i].checked=false;
    }
  }
});
/**
 * 初始化职责权限界面 
 */
function initRols(roleList) {
  $("select[name='userRole'] option").each(function(){ 
    $(this).remove();
  });
  var userRoleHtml="";
  for (var i=0; i<roleList.length; i++) {
    if (roleList[i].roleName=='管理员') continue;
    if (roleList[i].roleName=='超级管理员') continue;
    userRoleHtml+='<label><input type="radio" name="userRole" value="'+roleList[i].id+'" _text="'+roleList[i].roleName+'" onclick="roleClick()"/> '+roleList[i].roleName+' </label>';
  }
  $("#userRoleData").html(userRoleHtml);
}

function roleClick() {
  var choose=document.getElementsByName('userRole');
  for (var i=0; i<choose.length; i++) {
    if (choose[i].checked==true) {
      $("#role").val(choose[i].getAttribute("_text"));
      _uRole=choose[i].value;
    }
  }
  $("#userRoleModal").modal('hide');
  if (_uRole!="") $("#cleanRoleBtn").show();
}
/**
 * 注册用户
 */
function registerUser() {
  var inputData={};
  inputData.loginname=$("input[name='loginName']").val();
  inputData.password=$("input[name='pwd']").val();
  inputData.pwdConfirm=$("input[name='pwdConfirm']").val();
  inputData.mainphonenum=$("input[name='phoneNum']").val();
  inputData.realname=$("input[name='realName']").val();
  inputData.prjectNames=$("input[name='prjs']").val();
  inputData.roleId=_uRole;

  var errMsg=checkInput(inputData);

  if (errMsg!="") alert(errMsg);
  else {
    delete inputData.pwdConfirm;
    var url=_URL_BASE+"/wx/api/updateUserMsg";
    $.ajax({type:"post", async:true, url:url, data:inputData, dataType:"json",
      success: function(json) {
      if (json.msg=='100') window.location.href=_URL_BASE+"/wxfront/err.html?1000=已成功提交<br/>请等待管理员审核";
        else {
          var errStr="";
          if (json.msg=="103") errStr="程序出错";
          else if (json.msg=='200') errStr="登录名为空";
          else if (json.msg=='201') errStr="密码为空";
          else if (json.msg=='202') errStr="手机号为空";
          else if (json.msg=='203') errStr="姓名为空";
          else if (json.msg=='204') errStr="权限未设置";
          else if (json.msg=='205') errStr="项目未填写";
          if (errStr=="") errStr="未知错误";
          alert(errStr);
        }
      }
    });
  }

  //检查录入
  function checkInput(inputData) {
    if (!inputData.loginname) return "登录名为空";
    if (!inputData.password) return "密码为空";
    if (inputData.password.length<6) return "密码至少六位"; 
    if (inputData.password!=inputData.pwdConfirm) return "密码与密码确认不匹配";
    if (!inputData.mainphonenum) return "手机号为空";
    if (inputData.mainphonenum.length<11) return "手机号码不符合规则"; 
    if (!inputData.realname) return "姓名为空";
    if (!inputData.roleId) return "权限未设置";
    if (!inputData.prjectNames) return "项目未填写";
    return "";
  }
}
</script>
</html>